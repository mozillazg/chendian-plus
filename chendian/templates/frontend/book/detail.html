{% extends "frontend/base.html" %}

{% block extra_head %}
<style>
  .file-preview {
    border: 0;
  }
</style>
{% endblock extra_head %}


{% block content %}
<div class="row book-detail">
  <div class="col-md-5">
    <div class="panel panel-default">
      <div class="panel-heading">
        <span class="text-left">
          <a href="javascript: void(0);" data-toggle="modal"
            data-target=".bs-edit-book-modal-lg">更新书籍信息</a>
        </span>
        {% if request.user.is_staff %}
        <span class="text-right">
          <a href="{% url "book:book_list" %}?filter_by=id&filter_value={{ id }}">后台页面</a>
        </span>
        {% endif %}
      </div>
      <div class="panel-body">
        <div id="content" data-id="{{ id }}"></div>
      </div>
    </div>

  </div>

  <div class="col-md-7 checkin-list">
    <div class="panel panel-default">
      <div class="panel-heading">有 <span class="text-right" id="reader-count">0</span> 个小伙伴阅读过本书</div>
      <div class="panel-body">
        <div id="checkin-list"></div>
      </div>
      <div class="panel-footer clearfix"></div>
    </div>
  </div>

</div>

<div class="modal fade bs-edit-book-modal-lg" tabindex="-1" role="dialog" aria-labelledby="editBookModalLabel" id="editBookModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="editBookModalLabel">编辑书籍信息</h4>
      </div>
      <div class="modal-body">
        <form id="editBookForm">
          <div class="form-group">
            <label for="name">书名</label>
            <input type="text" class="form-control" id="name"
            placeholder="书名" required name="name">
          </div>
          <div class="form-group">
            <label for="author">作者</label>
            <input type="text" class="form-control" id="author"
            placeholder="作者" required name="author">
          </div>
          <div class="form-group">
            <label for="isbn">ISBN</label>
            <input type="text" class="form-control" id="isbn"
            placeholder="ISBN" name="isbn">
          </div>
          <div class="form-group">
            <label for="douban_url">豆瓣页面</label>
            <input type="text" class="form-control" id="douban_url"
            placeholder="douban_url" name="douban_url">
          </div>
          <div class="form-group">
            <label for="description">简介</label>
            <textarea class="form-control" id="description" name="description"
              rows="3" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
        <button type="button" class="btn btn-primary" id="editBookButton">更新</button>
      </div>
    </div> <!-- /.modal-content -->
  </div> <!-- /.modal-dialog -->
</div> <!-- /.modal -->
{% endblock content %}


{% block extra_js %}
<script src="{{ STATIC_URL }}js/frontend/checkin_list-0c3641c161.js"> </script>
<script src="{{ STATIC_URL }}js/frontend/book_detail-efb8362779.js"></script>
<script src="{{ STATIC_URL }}js/frontend/normal/book_edit-8bfdb6f039.js"> </script>
<script>
  $("#change-cover-input").fileinput({
    showCaption: false,
    showUpload: false,
    showRemove: false,
    uploadUrl: "/api/upload/", // server upload action
    uploadAsync: true,
    allowedFileTypes: ['image'],
    uploadExtraData: function() {
      return {'csrfmiddlewaretoken': "{{ csrf_token }}"}
    }
  });

  // update member avatar
  $("#change-cover-input").on('fileuploaded', function(event, data, previewId, index) {
    var response = data.response;
    var url = '/api/books/' + $('#content').data('id') + '/';
    $.ajax({
      url: url,
      dateType: 'json',
      contentType: 'application/json',
      type: 'patch',
      data: JSON.stringify({
        'cover': response.url
      }),
      success: function(data) {
        $("#book-cover").prop('src', data.cover);
        console.log('change cover success');
      }
    });
    console.log('File uploaded triggered');
  })
</script>
{% endblock extra_js %}
