{% extends "base.html" %}
{% load extra_tags %}

{% block title %}投稿 - {{ block.super }} {% endblock title %}

{% block extra_head %}
<link href="https://dn-tmp.qbox.me/x-editable-1.5.1/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet"/>
{% endblock extra_head %}

{% block content %}

<div class="row">
  <h2>
  {% if '/tags/' in request.path %}
  文章标签管理
  {% elif '/categories/' in request.path %}
  文章分类管理
  {% endif %}
  <small><a href="javascript: void(0);" class="label label-primary newObj">新增</a></small>
  </h2>
</div>

  {% include "page.html" %}


  <div class="row">
      <table class="table table-striped table-bordered table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>名称</th>
            <th>修改日期</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {% for obj in page_obj.object_list %}
          <tr>
            <td>{{ obj.id }}</td>

            <td>
              <a class="editable" data-id="{{ obj.pk }}" data-pk="{{ obj.pk }}"
                data-name="name"
                {% if '/tags/' in request.path %}
                data-url="{% url "api:blog:tag-detail" obj.pk %}"
                {% elif '/categories/' in request.path %}
                data-url="{% url "api:blog:category-detail" obj.pk %}"
                {% endif %}  href="javascript: void(0);">{{ obj.name }}</a>
            </td>

            <td>{{ obj.updated_at }}</td>
            <td>
              <a class="delete_record" href="javascript: void(0);"
                {% if '/tags/' in request.path %}
                data-url="{% url "api:blog:tag-detail" obj.pk %}"
                {% elif '/categories/' in request.path %}
                data-url="{% url "api:blog:article-detail" obj.pk %}"
                {% endif %}
                data-msg="你确定要删除?" data-method="delete"
                data-id="{{ obj.pk }}">删除</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
  </div>


  {% include "page.html" %}

  <div class="modal fade" id="add_modal" tabindex="-1" role="dialog"
    aria-hidden="true" >
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">
          {% if '/tags/' in request.path %}
          新增文章标签
          {% elif '/categories/' in request.path %}
          新增文章分类
          {% endif %}
          <h4>
      </div>
      <div class="modal-body">

      <form action="#" id="add_form_post">
        {% csrf_token %}
          <div class="form-group">
            <label for="addName">名称</label>
            <input class="form-control" type="text" name="name" id="addName" required>
          </div>
    </form>

    <div class="modal-footer">
      <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      <a class="btn btn-primary" id="post_add_form" data-id="0"
        href="javascript: void(0);">保存</a>
    </div>
  </div>
  </div>
</div>
</div>


  {% endblock content %}


  {% block extra_js %}
  <script src="https://dn-tmp.qbox.me/x-editable-1.5.1/bootstrap3-editable/js/bootstrap-editable.min.js"></script>
  <script>
    $(function(){

      setupEditable();
      $('.editable').editable();

      // delete
      $(".delete_record").on("click", function() {
        lazyClickHandler.bind(this)(function(){
          $(this).closest('tr').remove();
        }.bind(this));
      });


      $(".newObj").on("click", function() {
        $("#add_modal").modal("show");
      });
      $("#post_add_form").on("click", function() {
        var jsonData = {}
        $("#add_form_post").serializeArray().map(function(item) {
          jsonData[item.name] = item.value;
        });
        jsonData = JSON.stringify(jsonData);

        {% if '/tags/' in request.path %}
          var url = '{% url "api:blog:tag-list" %}';
        {% elif '/categories/' in request.path %}
        var url = '{% url "api:blog:category-list" %}';
        {% endif %}

        $.ajax({
          type: "POST",
          url: url,
          dataType: "json",
          contentType : "application/json",
          data: jsonData,
          success: function(data) {
            location.reload();
          }
        });
      });

    });
  </script>
  {% endblock extra_js %}
